<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>DJ Journey â€“ Virtual Badge Tracker</title>
<meta name="description" content="DJ Journey tracker: per-day attendance (Monâ€“Thu), XP, levels, and a Reward Shop with gold." />
<style>
  :root {
    --indigo: #4f46e5;
    --bg: #f8fafc;
    --card: #ffffff;
    --text: #111827;
    --muted: #6b7280;
    --border: #e5e7eb;
    --accent: #3730a3;
    --gold: #f59e0b;
    --green: #10b981;
    --red: #ef4444;
  }
  * { box-sizing: border-box; }
  body { margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif; background: var(--bg); color: var(--text); }
  header { position: sticky; top: 0; background: rgba(255,255,255,0.92); backdrop-filter: blur(6px); border-bottom: 1px solid #e0e7ff; }
  .container { max-width: 1140px; margin: 0 auto; padding: 16px; }
  .flex { display: flex; align-items: center; }
  .between { justify-content: space-between; }
  .title { font-weight: 800; font-size: 18px; }
  .subtitle { font-size: 12px; color: var(--muted); }
  .btn { border: 1px solid #e0e7ff; background: white; color: var(--accent); padding: 8px 12px; border-radius: 12px; font-weight: 600; cursor: pointer; }
  .btn.primary { background: var(--indigo); color: white; border-color: var(--indigo); }
  .btn.danger { color: #b91c1c; border-color: #fecaca; background: #fff; }
  .btn.success { color: white; background: var(--green); border-color: var(--green); }
  .btn.gold { color: #92400e; background: #fffbeb; border-color: #fde68a; }
  .btn:hover { filter: brightness(0.98); }
  .grid { display: grid; gap: 12px; }
  .card { background: var(--card); border: 1px solid var(--border); border-radius: 18px; padding: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.04); }
  .input, select { width: 100%; border: 1px solid var(--border); padding: 10px 12px; border-radius: 12px; outline: none; background: white; color: var(--text); }
  .input:focus, select:focus { border-color: #c7d2fe; box-shadow: 0 0 0 3px #e0e7ff; }
  .badge-pill { display: inline-flex; align-items: center; gap: 6px; border-radius: 999px; padding: 6px 10px; border: 1px solid var(--border); background: #f9fafb; font-size: 12px; }
  .student-card .pills { display: grid; grid-template-columns: repeat(4, minmax(0,1fr)); gap: 8px; }
  .progress { width: 54px; height: 54px; }
  .muted { color: var(--muted); }
  .controls { display: flex; gap: 8px; flex-wrap: wrap; }
  .leaderboard-row { display: grid; grid-template-columns: 28px 1fr 190px; gap: 8px; align-items: center; padding: 6px 0; border-bottom: 1px dashed #eef2ff; }
  .medal { font-size: 18px; }
  .xpbar { height: 8px; background: #e5e7eb; border-radius: 999px; overflow: hidden; }
  .xpbar > div { height: 100%; background: linear-gradient(90deg, #60a5fa, #4f46e5); }
  .chip { display:inline-flex; align-items:center; gap:6px; border:1px solid #fde68a; background:#fffbeb; color:#92400e; padding:4px 8px; border-radius:999px; font-size:12px; }
  .attendance-grid { display:grid; grid-template-columns: 80px repeat(4, 1fr); gap: 6px; align-items: center; }
  .att-head { font-weight: 700; font-size: 12px; color: #374151; text-align:center; }
  .att-week { font-size: 12px; color: #6b7280; text-align:center; }
  .att-cell { border:1px dashed #cbd5e1; border-radius:10px; padding:8px; text-align:center; }
  .att-on { background:#ecfeff; border-color:#a5f3fc; }
  .level { font-weight:800; color: var(--gold); }
  .gold { color: var(--gold); font-weight: 800; }
  .shop-grid { display:grid; grid-template-columns: repeat(auto-fill, minmax(220px,1fr)); gap: 10px; }
  .shop-item { display:flex; flex-direction:column; gap:6px; }
  .purchase { display:flex; align-items:center; justify-content:space-between; padding:8px; border:1px dashed var(--border); border-radius:12px; }
  .pill { display:inline-flex; align-items:center; gap:6px; border-radius:999px; padding:4px 8px; font-size:12px; border:1px solid #e5e7eb; background:#f9fafb; }
  @media (max-width: 640px) {
    .student-card .pills { grid-template-columns: repeat(2, minmax(0,1fr)); }
    .leaderboard-row { grid-template-columns: 24px 1fr 150px; }
    .attendance-grid { grid-template-columns: 60px repeat(4, 1fr); }
  }
  @media print {
    header, .controls, .hide-on-print { display: none !important; }
    .print-passport { display: block !important; }
    body { background: white; }
    .card { border: none; box-shadow: none; }
  }
  .switch { position: relative; display: inline-block; width: 44px; height: 24px; }
  .switch input { opacity: 0; width: 0; height: 0; }
  .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #e5e7eb; transition: .2s; border-radius: 999px; }
  .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; transition: .2s; border-radius: 50%; box-shadow: 0 1px 2px rgba(0,0,0,0.15); }
  input:checked + .slider { background-color: #4f46e5; }
  input:checked + .slider:before { transform: translateX(20px); }
  .checkbox { width: 18px; height: 18px; }
</style>
</head>
<body>
  <header>
    <div class="container flex between">
      <div class="flex" style="gap: 10px;">
        <div style="font-size: 24px;">ðŸŽ§</div>
        <div>
          <div class="title">DJ Journey â€“ Virtual Badge Tracker</div>
          <div class="subtitle">Gamified 8-week after-school program</div>
        </div>
      </div>
      <div id="header-tools" class="flex" style="gap: 12px;"></div>
    </div>
  </header>

  <main class="container" id="app"></main>

<script>
(function(){
  'use strict';

  // ---------- Config ----------
  const BADGES = [
    { id: "rhythm", name: "Rhythm Badge", emoji: "ðŸ¥" },
    { id: "mix", name: "Mix Badge", emoji: "ðŸŽšï¸" },
    { id: "sound", name: "Sound Badge", emoji: "ðŸŽ›ï¸" },
    { id: "scratch", name: "Scratch Badge", emoji: "ðŸ’¿" },
    { id: "producer", name: "Producer Badge", emoji: "ðŸŽ¹" },
    { id: "flow", name: "Flow Badge", emoji: "ðŸŽ¤" },
    { id: "performance", name: "Performance Badge", emoji: "ðŸŽ­" },
    { id: "master", name: "Master Badge", emoji: "ðŸ†" },
  ];
  const KEY = "dj-journey-xp-v3-shop";
  const XP_PER_BADGE = 50;
  const GOLD_PER_BADGE = 5;
  const XP_PER_ATTEND_DAY = 10; // per day (Monâ€“Thu)
  const GOLD_PER_ATTEND_DAY = 1;
  const LEVEL_SIZE = 100; // XP per level
  const DAYS = ["Mon","Tue","Wed","Thu"];

  const SHOP_ITEMS = [
    { id: "sticker", name: "Sticker", cost: 5, emoji: "ðŸ·ï¸" },
    { id: "song", name: "Song Request Token", cost: 8, emoji: "ðŸŽµ" },
    { id: "skip", name: "Skip-the-Line Turn", cost: 10, emoji: "â©" },
    { id: "bonusxp", name: "Bonus XP (+10)", cost: 6, emoji: "âš¡", grantsXP: 10 },
    { id: "mystery", name: "Mystery Pack", cost: 12, emoji: "ðŸŽ" }
  ];

  // ---------- Storage ----------
  function loadState(){
    try {
      const raw = localStorage.getItem(KEY);
      return raw ? JSON.parse(raw) : null;
    } catch { return null; }
  }
  function saveState(state){
    try { localStorage.setItem(KEY, JSON.stringify(state)); } catch {}
  }

  // ---------- App State ----------
  let state = loadState() || {
    students: [],
    view: "dashboard", // 'dashboard' | 'student'
    activeStudentId: null,
    currentWeek: 1,
    currentDay: 0, // 0..3 => Mon..Thu
    lockByWeek: true,
    query: ""
  };

  function setState(patch){
    state = { ...state, ...patch };
    saveState(state);
    render();
  }

  function findStudent(id){ return state.students.find(s => s.id === id) || null; }
  function pctBadges(s){
    const total = BADGES.length;
    const earned = BADGES.reduce((acc, b) => acc + (s.badges[b.id] ? 1 : 0), 0);
    return Math.round((earned / total) * 100);
  }

  function ensureStudentShape(s){
    if (!s.badges) s.badges = Object.fromEntries(BADGES.map(b => [b.id, false]));
    if (!Array.isArray(s.attendanceDays)) {
      if (Array.isArray(s.attendance)) {
        s.attendanceDays = s.attendance.map(w => [!!w, false, false, false]);
        delete s.attendance;
      } else {
        s.attendanceDays = Array.from({length:8}, ()=> Array(4).fill(false));
      }
    }
    if (typeof s.xp !== 'number') s.xp = 0;
    if (typeof s.gold !== 'number') s.gold = 0;
    if (!Array.isArray(s.purchases)) s.purchases = []; // {id,itemId,name,cost,ts,fulfilled}
    return s;
  }

  // ---------- Utilities ----------
  function h(tag, props={}, ...children){
    const el = document.createElement(tag);
    for (const [k,v] of Object.entries(props || {})){
      if (k === "class") el.className = v;
      else if (k === "style") Object.assign(el.style, v);
      else if (k.startsWith("on") && typeof v === "function"){
        el.addEventListener(k.slice(2).toLowerCase(), v);
      } else if (k === "html") {
        el.innerHTML = v;
      } else if (k === "checked") {
        if (v) el.setAttribute("checked", "checked");
      } else {
        el.setAttribute(k, v);
      }
    }
    for (const c of children){
      if (c == null) continue;
      if (Array.isArray(c)) el.append(...c);
      else if (c instanceof Node) el.appendChild(c);
      else el.appendChild(document.createTextNode(String(c)));
    }
    return el;
  }
  function uid(){ return Math.random().toString(36).slice(2) + Math.random().toString(36).slice(2); }

  function levelOf(xp){ return Math.floor(xp / LEVEL_SIZE) + 1; }
  function xpInLevel(xp){ return xp % LEVEL_SIZE; }
  function xpPercent(xp){ return Math.round((xpInLevel(xp) / LEVEL_SIZE) * 100); }

  function streakDays(attendanceDays){
    let s = 0;
    outer: for (let w = attendanceDays.length - 1; w >= 0; w--) {
      for (let d = attendanceDays[w].length - 1; d >= 0; d--) {
        const v = attendanceDays[w][d];
        if (v) s++;
        else break outer;
      }
    }
    return s;
  }

  // ---------- Header Tools ----------
  function HeaderTools(){
    const wrap = h("div", { class: "flex", style: { gap: "10px", alignItems: "center" } });

    // Week select
    wrap.append(
      h("label", { class: "subtitle", style: { display:"flex", alignItems:"center", gap:"6px" } },
        "Week:",
        h("select", { value: state.currentWeek, onChange: (e)=> setState({ currentWeek: parseInt(e.target.value,10) }) },
          ...Array.from({length:8}, (_,i)=> h("option", { value: i+1, ...(state.currentWeek===i+1?{selected:true}:{}) }, String(i+1)))
        )
      )
    );

    // Day select
    wrap.append(
      h("label", { class: "subtitle", style: { display:"flex", alignItems:"center", gap:"6px" } },
        "Day:",
        h("select", { value: state.currentDay, onChange: (e)=> setState({ currentDay: parseInt(e.target.value,10) }) },
          ...["Mon","Tue","Wed","Thu"].map((d,idx)=> h("option", { value: idx, ...(state.currentDay===idx?{selected:true}:{}) }, d))
        )
      )
    );

    // Lock-by-week toggle
    wrap.append(
      h("label", { class: "subtitle", style: { display:"flex", alignItems:"center", gap:"8px" } },
        "Lock by week",
        h("label", { class: "switch" },
          h("input", { type:"checkbox", ...(state.lockByWeek?{checked:true}:{}) , onChange: (e)=> setState({ lockByWeek: e.target.checked }) }),
          h("span", { class: "slider" })
        )
      )
    );

    // Dashboard button
    wrap.append(
      h("button", {
        class: "btn " + (state.view === "dashboard" ? "primary" : ""),
        onClick: ()=> setState({ view: "dashboard" })
      }, "Dashboard")
    );

    // Count
    wrap.append(h("span", { class: "subtitle" }, `${state.students.length} students`));

    return wrap;
  }

  // ---------- Views ----------
  function Dashboard(){
    const container = h("div", { class: "py-6 grid", style: { gap:"16px" } });

    // Add/Search tools
    const tools = h("div", { class: "card grid", style: { gridTemplateColumns:"2fr 1fr", gap:"16px" } },
      h("div", {},
        h("div", { class: "subtitle", style: { marginBottom:"8px", color:"#3730a3", fontWeight:"700" } }, "Add Student"),
        h("div", { class:"grid", style:{ gap:"8px", gridTemplateColumns:"1fr 1fr auto" } },
          h("input", { class:"input", placeholder:"Student name", id:"newName" }),
          h("input", { class:"input", placeholder:"DJ alias (optional)", id:"newAlias" }),
          h("button", { class:"btn primary", onClick: ()=> {
              const name = document.getElementById("newName").value.trim();
              const alias = document.getElementById("newAlias").value.trim();
              if (!name) return;
              const s = ensureStudentShape({ id: uid(), name, alias: alias || name, badges: null, attendanceDays: null, xp: 0, gold: 0, purchases: null });
              setState({ students: [...state.students, s] });
              document.getElementById("newName").value = "";
              document.getElementById("newAlias").value = "";
            } }, "Add")
        )
      ),
      h("div", {},
        h("div", { class: "subtitle", style: { marginBottom:"8px", color:"#3730a3", fontWeight:"700" } }, "Search / Tools"),
        h("input", { class:"input", placeholder:"Search by name or alias", value: state.query, onInput: (e)=> setState({ query: e.target.value }) }),
        h("div", { class:"controls", style:{ marginTop:"8px" } },
          h("button", { class:"btn", onClick: ()=> {
              const blob = new Blob([JSON.stringify({ students: state.students }, null, 2)], { type:"application/json" });
              const url = URL.createObjectURL(blob);
              const a = document.createElement("a");
              a.href = url; a.download = "dj-journey-export-"+new Date().toISOString().slice(0,10)+".json";
              a.click();
              URL.revokeObjectURL(url);
            } }, "Export JSON"),
          (()=>{
            const label = h("label", { class:"btn", style:{ cursor:"pointer" } }, "Import JSON");
            const input = h("input", { type:"file", accept:"application/json", style:{ display:"none" } });
            input.addEventListener("change", (e)=> {
              const file = e.target.files && e.target.files[0];
              if (!file) return;
              const reader = new FileReader();
              reader.onload = (ev)=> {
                try {
                  const data = JSON.parse(ev.target.result);
                  if (!Array.isArray(data.students)) throw new Error("Invalid file");
                  setState({ students: data.students.map(ensureStudentShape) });
                } catch(err){
                  alert("Import failed. Make sure this is a valid export file.");
                }
              };
              reader.readAsText(file);
            });
            label.appendChild(input);
            return label;
          })(),
          h("button", { class:"btn danger", style:{ marginLeft:"auto" }, onClick: ()=> {
              if (confirm("This will remove ALL students. Continue?")){
                setState({ students: [] });
              }
            } }, "Reset")
        )
      )
    );
    container.append(tools);

    // Badges + XP leaderboard
    const filtered = state.students.filter(s => {
      if (!state.query.trim()) return true;
      const q = state.query.toLowerCase();
      return s.name.toLowerCase().includes(q) || s.alias.toLowerCase().includes(q);
    }).map(ensureStudentShape);

    const badgesCard = h("div", { class:"card" },
      h("div", { class:"subtitle", style:{ marginBottom:"8px", color:"#3730a3", fontWeight:"700" } }, "Badges"),
      h("div", { class:"controls", style:{ gap:"8px", flexWrap:"wrap" } },
        ...BADGES.map(b => h("span", { class:"badge-pill" }, b.emoji, " ", b.name))
      ),
      h("div", { class:"subtitle", style:{ marginTop:"8px" } }, `Current Week: ${state.currentWeek} / 8 â€¢ Day: ${["Mon","Tue","Wed","Thu"][state.currentDay]}`)
    );

    const leaderboardXP = [...state.students].map(ensureStudentShape).sort((a,b)=> b.xp - a.xp || a.name.localeCompare(b.name)).slice(0,10);

    const medals = ["ðŸ¥‡","ðŸ¥ˆ","ðŸ¥‰"];
    const leaderCard = h("div", { class:"card" },
      h("div", { class:"subtitle", style:{ marginBottom:"8px", color:"#3730a3", fontWeight:"700" } }, "XP Leaderboard (Top 10)"),
      leaderboardXP.length===0 ? h("div", { class:"muted" }, "No students yet.") :
      h("div", {},
        ...leaderboardXP.map((row,i)=> {
          const lvl = levelOf(row.xp);
          const pct = xpPercent(row.xp);
          return h("div", { class:"leaderboard-row" },
            h("div", { class:"medal" }, medals[i] || "ðŸŽµ"),
            h("div", {}, 
              h("div", { style:{ fontWeight:"700" } }, row.name, " ", h("span", { class:"level" }, "Lv ", lvl)),
              h("div", { class:"muted", style:{ fontSize:"12px" } }, "aka ", row.alias),
              h("div", { class:"xpbar", style:{ marginTop:"6px" } }, h("div", { style:{ width: pct+'%' } } ))
            ),
            h("div", { class:"muted", style:{ textAlign:"right" } }, row.xp, " XP")
          );
        })
      )
    );

    container.append(
      h("div", { class:"grid", style:{ gridTemplateColumns:"2fr 1fr", gap:"16px" } }, badgesCard, leaderCard)
    );

    // Students Grid
    const grid = h("div", { class:"grid", style:{ gridTemplateColumns:"repeat(auto-fill, minmax(340px,1fr))", gap:"12px" } },
      ...filtered.map(s => {
        const ring = progressRingPct(pctBadges(s));
        const lvl = levelOf(s.xp);
        const pct = xpPercent(s.xp);

        const w = state.currentWeek - 1;
        const d = state.currentDay;
        const attended = s.attendanceDays[w][d];

        return h("div", { class:"card student-card" },
          h("div", { class:"flex between" },
            h("div", {}, 
              h("div", { style:{ fontWeight:"800" } }, s.name, " ", h("span", { class:"level" }, "Lv ", lvl)),
              h("div", { class:"muted", style:{ fontSize:"12px" } }, "aka ", s.alias)
            ),
            ring
          ),
          h("div", { class:"xpbar", style:{ marginTop:"8px" } }, h("div", { style:{ width: pct+'%' } } )),
          h("div", { class:"subtitle", style:{ marginTop:"6px" } }, s.xp, " XP â€¢ Day Streak: ", streakDays(s.attendanceDays), " ðŸ”¥"),
          h("div", { class:"controls", style:{ marginTop:"8px" } },
            h("button", { class:"btn success", onClick: ()=> addXP(s.id, 10) }, "+10 XP"),
            h("button", { class:"btn", onClick: ()=> addXP(s.id, 5) }, "+5 XP"),
            h("button", { class:"btn", onClick: ()=> addXP(s.id, -5) }, "-5 XP"),
            h("span", { class:"pill" }, "ðŸª™ ", s.gold, " gold"),
            h("button", { class:"btn gold", onClick: ()=> addGold(s.id, 1) }, "+1 gold"),
            h("button", { class:"btn gold", onClick: ()=> addGold(s.id, 5) }, "+5 gold"),
            h("span", { class:"chip", title:"Attendance gives +10 XP and +1 gold per day" },
              attended ? `âœ… Attended ${["Mon","Tue","Wed","Thu"][d]}` : `âºï¸ Mark ${["Mon","Tue","Wed","Thu"][d]}`
            ),
            h("button", { class:"btn", onClick: ()=> toggleAttendanceDay(s.id, w, d) }, attended ? "Undo Attend" : "Mark Attend")
          ),
          h("div", { class:"pills", style:{ marginTop:"12px" } },
            ...BADGES.map(b => h("span", {
              class:"badge-pill",
              title: b.name,
              style: s.badges[b.id] ? { background:"#eef2ff", color:"#3730a3", borderColor:"#c7d2fe" } : {}
            }, b.emoji))
          ),
          h("div", { class:"controls", style:{ marginTop:"12px" } },
            h("button", { class:"btn primary", onClick: ()=> setState({ view:"student", activeStudentId: s.id }) }, "Open"),
            h("button", { class:"btn danger", onClick: ()=> setState({ students: state.students.filter(st => st.id !== s.id) }) }, "Remove")
          )
        );
      })
    );
    container.append(grid);

    if (filtered.length === 0){
      container.append(h("div", { style:{ marginTop:"10px", textAlign:"center" }, class:"muted" }, "No students yet. Add your first student above."));
    }

    return container;
  }

  function StudentView(){
    const s = ensureStudentShape(findStudent(state.activeStudentId));
    if (!s){
      return h("div", { class:"card", style:{ marginTop:"16px" } },
        h("div", { class:"muted" }, "No student selected."),
        h("button", { class:"btn", style:{ marginTop:"8px" }, onClick: ()=> setState({ view:"dashboard" }) }, "Back")
      );
    }
    const earned = BADGES.filter(b => s.badges[b.id]).length;
    const percent = Math.round((earned / BADGES.length) * 100);
    const lvl = levelOf(s.xp);
    const pct = xpPercent(s.xp);

    // Badge checkboxes (with XP & gold on earn)
    const boxList = h("div", { class:"grid", style:{ gridTemplateColumns:"1fr 1fr", gap:"8px", marginTop:"12px" } },
      ...BADGES.map((b, i) => {
        const week = i+1;
        const locked = state.lockByWeek && week > state.currentWeek;
        const label = h("label", { class:"card", style:Object.assign(
          { padding:"10px", display:"flex", alignItems:"center", gap:"10px" },
          s.badges[b.id] ? { borderColor:"#c7d2fe", background:"#eef2ff" } : {},
          locked ? { opacity:"0.6" } : {}
        )},
          (()=>{
            const input = h("input", { type:"checkbox", class:"checkbox", ...(s.badges[b.id]?{checked:true}:{}) });
            input.disabled = locked;
            input.addEventListener("change", ()=> {
              const was = !!s.badges[b.id];
              const now = !was;
              const updated = state.students.map(st => st.id===s.id ? { ...st, badges:{ ...st.badges, [b.id]: now } } : st);
              setState({ students: updated });
              if (now && !was) { addXP(s.id, XP_PER_BADGE); addGold(s.id, GOLD_PER_BADGE); }
              if (!now && was) { addXP(s.id, -XP_PER_BADGE); addGold(s.id, -GOLD_PER_BADGE); }
            });
            return input;
          })(),
          h("div", { style:{ fontSize:"20px" } }, b.emoji),
          h("div", {}, h("div", { style:{ fontWeight:"700" } }, b.name), h("div", { class:"muted", style:{ fontSize:"10px" } }, "Week ", week, locked ? " â€¢ Locked" : ""))
        );
        return label;
      })
    );

    // Attendance 8x4 grid
    const headRow = h("div", { class:"attendance-grid", style:{ marginTop:"8px" } },
      h("div", { class:"att-head" }, ""),
      ...["Mon","Tue","Wed","Thu"].map(d => h("div", { class:"att-head" }, d))
    );
    const rows = s.attendanceDays.map((weekArr, wIdx) => {
      return h("div", { class:"attendance-grid" },
        h("div", { class:"att-week" }, "Week ", (wIdx+1)),
        ...weekArr.map((on, dIdx) => h("div", { class:"att-cell " + (on ? "att-on" : "") },
          h("button", { class:"btn", onClick: ()=> toggleAttendanceDay(s.id, wIdx, dIdx) }, on ? "Undo" : "Attend")
        ))
      );
    });

    // Shop UI
    const shop = h("div", { class:"card" },
      h("div", { class:"flex between" },
        h("div", { class:"subtitle", style:{ color:"#3730a3", fontWeight:"700" } }, "Reward Shop"),
        h("div", { class:"pill" }, "ðŸª™ ", s.gold, " gold")
      ),
      h("div", { class:"shop-grid", style:{ marginTop:"8px" } },
        ...SHOP_ITEMS.map(item => {
          const canBuy = s.gold >= item.cost;
          return h("div", { class:"card shop-item" },
            h("div", { class:"flex between" },
              h("div", { style:{ fontWeight:"700" } }, item.emoji, " ", item.name),
              h("div", { class:"gold" }, item.cost, "g")
            ),
            h("button", { class:"btn " + (canBuy ? "gold" : ""), disabled: canBuy ? undefined : true, onClick: ()=> buyItem(s.id, item.id) },
              canBuy ? "Buy" : "Need " + (item.cost - s.gold) + "g"
            )
          );
        })
      ),
      h("div", { class:"subtitle", style:{ marginTop:"10px", color:"#374151" } }, "Purchases"),
      (s.purchases && s.purchases.length > 0) ?
        h("div", { class:"grid" },
          ...s.purchases.map(p => {
            const item = SHOP_ITEMS.find(i=>i.id===p.itemId);
            const label = item ? (item.emoji + " " + item.name) : p.name;
            return h("div", { class:"purchase" },
              h("div", {}, label, " â€¢ ", p.cost, "g", " ", h("span", { class:"muted", style:{ fontSize:"12px" } }, new Date(p.ts).toLocaleString())),
              h("label", {}, 
                h("input", { type:"checkbox", ...(p.fulfilled?{checked:true}:{}) , onChange: ()=> toggleFulfilled(s.id, p.id) }),
                " Fulfilled"
              )
            );
          })
        ) :
        h("div", { class:"muted" }, "No purchases yet.")
    );

    const content = h("div", { class:"py-6 grid", style:{ gap:"16px" } },
      h("div", { class:"card" },
        h("div", { class:"flex between" },
          h("div", {}, 
            h("div", { style:{ fontWeight:"800", fontSize:"18px" } }, s.name, " ", h("span", { class:"level" }, "Lv ", lvl)),
            h("div", { class:"muted", style:{ fontSize:"12px" } }, "DJ Alias: ", s.alias)
          ),
          progressRingPct(percent, 60)
        ),
        h("div", { class:"xpbar", style:{ marginTop:"8px" } }, h("div", { style:{ width: pct+'%' } } )),
        h("div", { class:"subtitle", style:{ marginTop:"6px" } }, s.xp, " XP â€¢ Day Streak: ", streakDays(s.attendanceDays), " ðŸ”¥"),
        h("div", { class:"controls", style:{ marginTop:"8px" } },
          h("span", { class:"pill" }, "ðŸª™ ", s.gold, " gold"),
          h("button", { class:"btn gold", onClick: ()=> addGold(s.id, 1) }, "+1 gold"),
          h("button", { class:"btn gold", onClick: ()=> addGold(s.id, 5) }, "+5 gold")
        ),
        boxList
      ),

      h("div", { class:"card" },
        h("div", { class:"subtitle", style:{ marginBottom:"8px", color:"#3730a3", fontWeight:"700" } }, "Attendance by Day (Tap to toggle)"),
        headRow,
        ...rows
      ),

      shop,

      // Print-only passport (unchanged)
      h("div", { class:"card print-passport", style:{ display:"none" } },
        h("div", { class:"flex between", style:{ marginBottom:"8px" } },
          h("div", {}, h("div", { style:{ fontWeight:"800", fontSize:"20px" } }, "ðŸŽ§ DJ Journey Passport"), h("div", { class:"muted", style:{ fontSize:"12px" } }, "Student: ", s.name, " â€¢ Alias: ", s.alias)),
          h("div", { class:"muted", style:{ fontSize:"12px" } }, "Badges: ", earned, " / ", BADGES.length)
        ),
        h("div", { class:"grid", style:{ gridTemplateColumns:"1fr 1fr", gap:"8px" } },
          ...BADGES.map((b,i)=> h("div", { class:"card", style:{ padding:"10px", display:"flex", alignItems:"center", gap:"8px", borderStyle:"dashed" } },
            h("div", { style:{ fontSize:"20px" } }, b.emoji),
            h("div", { style:{ flex:1 } }, h("div", { style:{ fontWeight:"700" } }, b.name), h("div", { class:"muted", style:{ fontSize:"10px" } }, "Week ", i+1)),
            h("div", { style:{ width:"18px", height:"18px", border:"1px solid #cbd5e1", borderRadius:"4px", background: s.badges[b.id] ? "#4f46e5" : "transparent" } })
          ))
        )
      )
    );

    return content;
  }

  // ---------- Actions ----------
  function addXP(studentId, delta){
    const updated = state.students.map(s => {
      if (s.id !== studentId) return s;
      const xp = Math.max(0, (s.xp || 0) + delta);
      return { ...ensureStudentShape(s), xp };
    });
    setState({ students: updated });
  }
  function addGold(studentId, delta){
    const updated = state.students.map(s => {
      if (s.id !== studentId) return s;
      const gold = Math.max(0, (s.gold || 0) + delta);
      return { ...ensureStudentShape(s), gold };
    });
    setState({ students: updated });
  }

  function toggleAttendanceDay(studentId, weekIdx, dayIdx){
    const updated = state.students.map(s => {
      if (s.id !== studentId) return s;
      const st = ensureStudentShape({ ...s });
      const was = !!st.attendanceDays[weekIdx][dayIdx];
      const now = !was;
      st.attendanceDays[weekIdx][dayIdx] = now;
      // Rewards per day
      const xpDelta = now ? XP_PER_ATTEND_DAY : -XP_PER_ATTEND_DAY;
      const goldDelta = now ? GOLD_PER_ATTEND_DAY : -GOLD_PER_ATTEND_DAY;
      st.xp = Math.max(0, (st.xp || 0) + xpDelta);
      st.gold = Math.max(0, (st.gold || 0) + goldDelta);
      return st;
    });
    setState({ students: updated });
  }

  function buyItem(studentId, itemId){
    const updated = state.students.map(s => {
      if (s.id !== studentId) return s;
      const st = ensureStudentShape({ ...s });
      const item = SHOP_ITEMS.find(i=>i.id===itemId);
      if (!item) return st;
      if ((st.gold || 0) < item.cost) return st;
      st.gold = (st.gold || 0) - item.cost;
      // If item grants XP immediately
      if (item.grantsXP) st.xp = Math.max(0, (st.xp || 0) + item.grantsXP);
      const purchase = { id: uid(), itemId: item.id, name: item.name, cost: item.cost, ts: Date.now(), fulfilled: false };
      st.purchases = Array.isArray(st.purchases) ? [purchase, ...st.purchases] : [purchase];
      return st;
    });
    setState({ students: updated });
  }

  function toggleFulfilled(studentId, purchaseId){
    const updated = state.students.map(s => {
      if (s.id !== studentId) return s;
      const st = ensureStudentShape({ ...s });
      st.purchases = (st.purchases || []).map(p => p.id === purchaseId ? { ...p, fulfilled: !p.fulfilled } : p);
      return st;
    });
    setState({ students: updated });
  }

  // ---------- Small SVG progress helper ----------
  function progressRingPct(percent, size=54){
    const stroke = 6;
    const r = (size - stroke) / 2;
    const c = 2 * Math.PI * r;
    const dash = (percent / 100) * c;
    const svgNS = "http://www.w3.org/2000/svg";
    const svg = document.createElementNS(svgNS, "svg");
    svg.setAttribute("width", size);
    svg.setAttribute("height", size);
    svg.setAttribute("viewBox", `0 0 ${size} ${size}`);

    const bg = document.createElementNS(svgNS, "circle");
    bg.setAttribute("cx", size/2); bg.setAttribute("cy", size/2);
    bg.setAttribute("r", r); bg.setAttribute("stroke", "#e5e7eb"); bg.setAttribute("stroke-width", stroke); bg.setAttribute("fill", "none");
    svg.appendChild(bg);

    const fg = document.createElementNS(svgNS, "circle");
    fg.setAttribute("cx", size/2); fg.setAttribute("cy", size/2);
    fg.setAttribute("r", r); fg.setAttribute("stroke", "#4f46e5"); fg.setAttribute("stroke-width", stroke); fg.setAttribute("fill", "none");
    fg.setAttribute("stroke-linecap", "round");
    fg.setAttribute("stroke-dasharray", `${dash} ${c}`);
    fg.setAttribute("transform", `rotate(-90 ${size/2} ${size/2})`);
    svg.appendChild(fg);

    const txt = document.createElementNS(svgNS, "text");
    txt.setAttribute("x","50%"); txt.setAttribute("y","50%");
    txt.setAttribute("dominant-baseline","middle"); txt.setAttribute("text-anchor","middle");
    txt.setAttribute("font-size","12"); txt.setAttribute("fill","#111827");
    txt.textContent = percent + "%";
    svg.appendChild(txt);
    return svg;
  }

  // ---------- Render ----------
  function renderHeader(){
    const mount = document.getElementById("header-tools");
    mount.innerHTML = "";
    mount.appendChild(HeaderTools());
  }

  function render(){
    state.students = state.students.map(ensureStudentShape);
    renderHeader();
    const root = document.getElementById("app");
    root.innerHTML = "";
    if (state.view === "dashboard") root.appendChild(Dashboard());
    else root.appendChild(StudentView());
  }

  // First render
  render();

})();</script>

</body>
</html>
