import React, { useEffect, useMemo, useRef, useState } from "react";

// DJ Journey Tracker v8 — single-file React app
// Features
// - Add/rename/remove students
// - Track XP, levels, badges, attendance (Mon–Thu), weekly tasks
// - Preloaded curriculum tasks (Weeks 1–6 detailed from Unit 1; Weeks 7–36 templated)
// - Quick XP awards (+10/+20/+30/+50/+100)
// - Reward Shop (spend XP)
// - Notes per student
// - Export / Import (JSON)
// - LocalStorage persistence
// - Clean Tailwind UI

// ---------------------- Utility ----------------------
const STORAGE_KEY = "dj_journey_tracker_v8";
const uid = () => Math.random().toString(36).slice(2, 9);
const today = () => new Date().toISOString().slice(0, 10);

function useLocalState(key, initial) {
  const [state, setState] = useState(() => {
    const raw = localStorage.getItem(key);
    return raw ? JSON.parse(raw) : initial;
  });
  useEffect(() => {
    localStorage.setItem(key, JSON.stringify(state));
  }, [key, state]);
  return [state, setState];
}

// ---------------------- Curriculum ----------------------
// Compact schema: weeks are 1..36
// Each week: { title, unit, tasks: [{id, title, xp, type:("portfolio"|"media"|"challenge"|"wellness"|"sidequest"|"class")}], badge?:{name, when:"Thu"} }

const W = (w, unit, title, tasks, badge) => ({ w, unit, title, tasks: tasks.map((t, i) => ({ id: `${w}-${i+1}`, ...t })), badge });

// Helper task constructors
const T = (title, xp, type = "class") => ({ title, xp, type });
const Challenge = (title, xp = 30) => T(`Challenge: ${title}`, xp, "challenge");
const Side = (title, xp = 25) => T(`Side Quest: ${title}`, xp, "sidequest");
const Wellness = (title, xp = 0) => T(`Wellness: ${title}`, 0, "wellness");
const Portfolio = (title, xp = 0) => T(`Portfolio: ${title}`, xp, "portfolio");

// Weeks 1-6 detailed (from Unit 1)
const weeksDetailed = [
  W(1, "Unit 1 — Starter Region", "Welcome to DJing", [
    T("Mon: Notes on Parts of a DJ Setup", 10),
    T("Mon: Track Analysis", 10),
    Wellness("Protect your hearing — never redline"),
    Portfolio("Draw + label gear diagram"),
    Side("Setup Scout — explain signal flow to a peer", 20),
    T("Tue: Identify controller parts (guided)", 20),
    T("Wed: Practice headphone cue buttons (lab)", 20),
    Portfolio("Cue diagram annotated"),
    Challenge("Thu: Identify 5 gear parts + cue one track", 30),
    Side("Film yourself explaining gear to a parent/friend", 25),
  ]),
  W(2, "Unit 1 — Starter Region", "Song Structure & Track Anatomy", [
    T("Mon: Bars, phrases, intros, outros", 20),
    Wellness("Stand straight, avoid wrist strain"),
    Portfolio("Mark sections in 2 tracks"),
    T("Tue: Count bars in popular songs", 20),
    T("Wed: Color‑code waveforms in Rekordbox", 20),
    Challenge("Thu: Identify 3 sections of a random track live", 30),
    Side("Find & mark song structure of your favorite non‑DJ track", 25),
  ]),
  W(3, "Unit 1 — Starter Region", "Cueing Basics", [
    T("Mon: Hot cues + headphone cue", 20),
    Wellness("Keep headphone levels safe"),
    Portfolio("Save first cue playlist"),
    T("Tue: Set cue points in Rekordbox", 20),
    T("Wed: Practice cueing multiple songs", 20),
    Side("Hot Cue Hunter — set 5 cues in under 1 min", 25),
    Challenge("Thu: Cue a track in 30 seconds", 30),
  ]),
  W(4, "Unit 1 — Starter Region", "Track Selection & Energy", [
    T("Mon: Energy flow + crate digging", 20),
    Wellness("Don’t panic — breathe before choosing"),
    Portfolio("3‑song energy curve playlist"),
    T("Tue: Energy progression in a set (guided)", 20),
    T("Wed: Build crates (lab)", 20),
    Challenge("Thu: Present playlists; peers vote", 30),
    T("Scenario: Bride requests slow jam mid‑hype set — plan response", 0, "class"),
  ]),
  W(5, "Unit 1 — Starter Region", "First Transitions", [
    T("Mon: Crossfader + volume fader basics", 20),
    Wellness("Posture — don’t lean on faders"),
    Portfolio("Record 30‑second transition"),
    T("Tue: Crossfade 2 songs (guided)", 20),
    T("Wed: EQ vs crossfade transitions (lab)", 20),
    Challenge("Thu: Perform 1 clean transition", 30),
    Side("Genre Jumper — mix 2 different genres", 25),
  ]),
  W(6, "Unit 1 — Starter Region", "Gym Leader Challenge — Cue Badge", [
    T("Mon: Review gear, cue, crossfade", 20),
    Wellness("Nerves — breathe & prep"),
    Portfolio("Submit diagram, cue list, playlist, transition recording"),
    T("Tue: Mock test (run full routine)", 20),
    T("Wed: Peer review — refine", 20),
    Challenge("Thu Exam: Identify gear + cue track + 2‑song transition", 100),
  ], { name: "Cue Badge", when: "Thu" }),
];

// Template generator for Weeks 7–36 (summary tasks to keep code compact)
function generateTemplateWeeks(start, end, unitName, weeklyTheme, badgeAtEnd, badgeName) {
  const weeks = [];
  for (let w = start; w <= end; w++) {
    const weekIndex = w - start + 1;
    const title = `${weeklyTheme} — Week ${weekIndex}`;
    const base = [
      T("Mon: Lesson & notes", 20),
      Portfolio("Portfolio task (upload/log)"),
      T("Tue: Guided practice", 20),
      T("Wed: Lab practice", 20),
      Challenge("Thu: Weekly challenge", 30),
      Side("Optional side quest", 25),
    ];
    const badge = badgeAtEnd && w === end ? { name: badgeName, when: "Thu" } : undefined;
    weeks.push(W(w, unitName, title, base, badge));
  }
  return weeks;
}

const weeks7to12 = generateTemplateWeeks(7, 12, "Unit 2 — Rhythm City", "Rhythm & Beatmatching", true, "Beat Badge");
const weeks13to18 = generateTemplateWeeks(13, 18, "Unit 3 — Harmony Heights", "Harmony & Keys", true, "Harmony Badge");
const weeks19to24 = generateTemplateWeeks(19, 24, "Unit 4 — Remix Canyon", "Sampling & Remix", true, "Remix Badge");
const weeks25to27 = generateTemplateWeeks(25, 27, "Unit 5 — Setup Summit", "Setups & Troubleshooting", true, "Setup Badge");
const weeks28to31 = generateTemplateWeeks(28, 31, "Unit 6 — Styles Arena", "Styles & Roles", true, "Style Badge");
const weeks32to34 = generateTemplateWeeks(32, 34, "Unit 7 — Genre Forge", "Global Genres", true, "Genre Badge");
const weeks35to36 = generateTemplateWeeks(35, 36, "Unit 8 — Turntablist Tower", "Scratching & Battles", true, "Scratch Badge");

const CURRICULUM = [
  ...weeksDetailed,
  ...weeks7to12,
  ...weeks13to18,
  ...weeks19to24,
  ...weeks25to27,
  ...weeks28to31,
  ...weeks32to34,
  ...weeks35to36,
];

// Reward Shop items
const SHOP = [
  { id: "sticker", name: "Sticker", cost: 50 },
  { id: "cue-pin", name: "Cue Badge Pin", cost: 200 },
  { id: "song-request", name: "Song Request Pass", cost: 120 },
  { id: "extra-credit", name: "Extra Credit +25 XP", cost: 100 },
  { id: "dj-pass", name: "Lunch DJ Slot", cost: 250 },
  { id: "boss-battle", name: "Boss Battle: 1v1 DJ", cost: 180 },
];

// ---------------------- Components ----------------------
function Header({ activeWeek, setActiveWeek, totalWeeks }) {
  return (
    <div className="flex flex-col gap-3 md:flex-row md:items-end md:justify-between">
      <div>
        <h1 className="text-3xl font-bold">DJ Journey Tracker v8</h1>
        <p className="text-sm text-gray-500">XP • Attendance • Badges • Rewards — saved locally</p>
      </div>
      <div className="flex items-center gap-2">
        <label className="text-sm">Week</label>
        <input
          type="number"
          min={1}
          max={totalWeeks}
          value={activeWeek}
          onChange={(e) => setActiveWeek(Number(e.target.value))}
          className="w-20 rounded-xl border px-3 py-1"
        />
      </div>
    </div>
  );
}

function StudentManager({ students, setStudents, setActiveStudentId }) {
  const [name, setName] = useState("");
  const add = () => {
    if (!name.trim()) return;
    const s = {
      id: uid(),
      name: name.trim(),
      xp: 0,
      badges: [],
      notes: "",
      attendance: {}, // { week: {Mon:true, Tue:false, ...}}
      completed: {}, // { taskId: true }
      purchases: [],
    };
    setStudents((arr) => [...arr, s]);
    setName("");
    setActiveStudentId(s.id);
  };
  const remove = (id) => setStudents((arr) => arr.filter((s) => s.id !== id));
  const rename = (id, newName) => setStudents((arr) => arr.map((s) => (s.id === id ? { ...s, name: newName } : s)));

  return (
    <div className="rounded-2xl border p-4 shadow-sm">
      <h2 className="mb-2 text-xl font-semibold">Students</h2>
      <div className="mb-3 flex gap-2">
        <input
          placeholder="Add student name"
          value={name}
          onChange={(e) => setName(e.target.value)}
          onKeyDown={(e) => e.key === "Enter" && add()}
          className="flex-1 rounded-xl border px-3 py-2"
        />
        <button onClick={add} className="rounded-xl bg-black px-4 py-2 text-white hover:opacity-90">Add</button>
      </div>
      <div className="grid grid-cols-1 gap-2 md:grid-cols-2 lg:grid-cols-3">
        {students.map((s) => (
          <div key={s.id} className="flex items-center justify-between rounded-xl border p-3">
            <div>
              <input
                value={s.name}
                onChange={(e) => rename(s.id, e.target.value)}
                className="rounded-lg border px-2 py-1"
              />
              <div className="text-xs text-gray-500">XP: {s.xp} • Badges: {s.badges.length}</div>
            </div>
            <div className="flex gap-2">
              <button onClick={() => setActiveStudentId(s.id)} className="rounded-lg border px-3 py-1">Open</button>
              <button onClick={() => remove(s.id)} className="rounded-lg border px-3 py-1 text-red-600">Remove</button>
            </div>
          </div>
        ))}
      </div>
    </div>
  );
}

function XPButtons({ onGive }) {
  const amounts = [10, 20, 30, 50, 100];
  return (
    <div className="flex flex-wrap items-center gap-2">
      {amounts.map((n) => (
        <button key={n} onClick={() => onGive(n)} className="rounded-xl border px-3 py-1">+{n} XP</button>
      ))}
    </div>
  );
}

function Attendance({ student, week, updateStudent }) {
  const days = ["Mon", "Tue", "Wed", "Thu"];
  const rec = student.attendance?.[week] || {};
  const toggle = (d) => {
    const newRec = { ...rec, [d]: !rec[d] };
    const att = { ...(student.attendance || {}), [week]: newRec };
    updateStudent({ attendance: att });
  };
  const count = days.filter((d) => rec[d]).length;
  return (
    <div className="rounded-xl border p-3">
      <div className="mb-1 text-sm font-medium">Attendance (Week {week})</div>
      <div className="flex gap-2">
        {days.map((d) => (
          <button
            key={d}
            onClick={() => toggle(d)}
            className={`rounded-lg px-3 py-1 border ${rec[d] ? "bg-green-100" : "bg-white"}`}
          >
            {d}
          </button>
        ))}
      </div>
      <div className="mt-2 text-xs text-gray-500">Marked: {count}/4</div>
    </div>
  );
}

function WeekTasks({ week, student, updateStudent, onAwardBadge }) {
  const data = useMemo(() => CURRICULUM.find((x) => x.w === week), [week]);
  if (!data) return <div className="italic text-gray-500">No week data.</div>;

  const completed = student.completed || {};
  const toggleTask = (task) => {
    const key = task.id;
    const already = !!completed[key];
    const newCompleted = { ...completed, [key]: !already };

    let delta = 0;
    if (!already) delta += task.xp || 0; // grant XP when checking
    else delta -= task.xp || 0; // remove if unchecked

    const newXP = Math.max(0, (student.xp || 0) + delta);

    // Auto-badge if present and it's Thursday challenge checked
    if (data.badge && task.title.toLowerCase().includes("challenge") && !already) {
      onAwardBadge(data.badge.name);
    }

    updateStudent({ completed: newCompleted, xp: newXP });
  };

  return (
    <div className="rounded-2xl border p-4 shadow-sm">
      <div className="mb-2 flex flex-wrap items-end justify-between gap-2">
        <div>
          <div className="text-xs uppercase tracking-wide text-gray-500">{data.unit}</div>
          <h3 className="text-lg font-semibold">Week {data.w}: {data.title}</h3>
        </div>
        {data.badge && (
          <div className="rounded-full border px-3 py-1 text-sm">🏅 Badge Week: {data.badge.name}</div>
        )}
      </div>
      <ol className="space-y-2">
        {data.tasks.map((t) => (
          <li key={t.id} className="flex items-center justify-between gap-3 rounded-xl border p-2">
            <div>
              <div className="font-medium">{t.title}</div>
              <div className="text-xs text-gray-500">Type: {t.type} {t.xp ? `• XP ${t.xp}` : ""}</div>
            </div>
            <button
              onClick={() => toggleTask(t)}
              className={`rounded-xl px-3 py-1 border ${completed[t.id] ? "bg-black text-white" : "bg-white"}`}
            >
              {completed[t.id] ? "Completed" : "Mark +XP"}
            </button>
          </li>
        ))}
      </ol>
    </div>
  );
}

function RewardShop({ student, updateStudent }) {
  const buy = (item) => {
    if ((student.xp || 0) < item.cost) return alert("Not enough XP.");
    const purchases = [...(student.purchases || []), { id: uid(), itemId: item.id, name: item.name, cost: item.cost, date: today() }];
    updateStudent({ purchases, xp: student.xp - item.cost });
  };
  return (
    <div className="rounded-2xl border p-4 shadow-sm">
      <div className="mb-2 text-xl font-semibold">Reward Shop</div>
      <div className="grid grid-cols-1 gap-2 md:grid-cols-2 lg:grid-cols-3">
        {SHOP.map((it) => (
          <div key={it.id} className="flex items-center justify-between rounded-xl border p-3">
            <div>
              <div className="font-medium">{it.name}</div>
              <div className="text-xs text-gray-500">Cost: {it.cost} XP</div>
            </div>
            <button onClick={() => buy(it)} className="rounded-xl border px-3 py-1">Buy</button>
          </div>
        ))}
      </div>
      {student.purchases?.length ? (
        <div className="mt-3 rounded-xl border p-3">
          <div className="mb-1 text-sm font-medium">Purchase History</div>
          <ul className="text-sm">
            {student.purchases.map((p) => (
              <li key={p.id} className="flex justify-between border-b py-1 last:border-0">
                <span>{p.date} — {p.name}</span>
                <span className="text-gray-500">-{p.cost} XP</span>
              </li>
            ))}
          </ul>
        </div>
      ) : null}
    </div>
  );
}

function BadgeRack({ badges }) {
  if (!badges || badges.length === 0) return <div className="text-sm text-gray-500">No badges yet.</div>;
  return (
    <div className="flex flex-wrap gap-2">
      {badges.map((b, i) => (
        <div key={i} className="rounded-full border px-3 py-1 text-sm">{b}</div>
      ))}
    </div>
  );
}

function StudentPanel({ student, setStudents, week }) {
  const updateStudent = (patch) => {
    setStudents((arr) => arr.map((s) => (s.id === student.id ? { ...s, ...patch } : s)));
  };
  const giveXP = (n) => updateStudent({ xp: (student.xp || 0) + n });
  const awardBadge = (name) => {
    if ((student.badges || []).includes(name)) return; // no dupes
    updateStudent({ badges: [...(student.badges || []), name] });
  };

  const level = 1 + Math.floor((student.xp || 0) / 100); // 100 XP per level

  return (
    <div className="grid grid-cols-1 gap-4 md:grid-cols-3">
      <div className="md:col-span-1 space-y-3">
        <div className="rounded-2xl border p-4 shadow-sm">
          <div className="mb-1 text-xs uppercase tracking-wide text-gray-500">Student</div>
          <div className="text-2xl font-bold">{student.name}</div>
          <div className="mt-2 flex items-center gap-3">
            <div className="rounded-xl border px-3 py-2 text-center">
              <div className="text-xs text-gray-500">XP</div>
              <div className="text-xl font-semibold">{student.xp}</div>
            </div>
            <div className="rounded-xl border px-3 py-2 text-center">
              <div className="text-xs text-gray-500">Level</div>
              <div className="text-xl font-semibold">{level}</div>
            </div>
          </div>
          <div className="mt-3">
            <XPButtons onGive={giveXP} />
          </div>
          <div className="mt-4">
            <div className="mb-1 text-sm font-medium">Badges</div>
            <BadgeRack badges={student.badges} />
          </div>
          <div className="mt-4">
            <label className="mb-1 block text-sm font-medium">Notes</label>
            <textarea
              value={student.notes || ""}
              onChange={(e) => updateStudent({ notes: e.target.value })}
              className="h-28 w-full rounded-xl border p-2"
              placeholder="Progress notes, feedback, goals..."
            />
          </div>
        </div>
        <Attendance student={student} week={week} updateStudent={updateStudent} />
        <RewardShop student={student} updateStudent={updateStudent} />
      </div>
      <div className="md:col-span-2 space-y-3">
        <WeekTasks week={week} student={student} updateStudent={updateStudent} onAwardBadge={awardBadge} />
      </div>
    </div>
  );
}

function DataMenu({ data, setData }) {
  const [show, setShow] = useState(false);
  const [txt, setTxt] = useState("");
  const exportData = () => setTxt(JSON.stringify(data, null, 2));
  const importData = () => {
    try {
      const obj = JSON.parse(txt);
      setData(obj);
      alert("Imported.");
    } catch (e) {
      alert("Invalid JSON");
    }
  };
  const reset = () => {
    if (confirm("Reset all data? This cannot be undone.")) setData({ students: [] });
  };
  return (
    <div className="rounded-2xl border p-4 shadow-sm">
      <div className="mb-2 flex items-center justify-between">
        <div className="text-xl font-semibold">Data & Backup</div>
        <button onClick={() => setShow((v) => !v)} className="rounded-xl border px-3 py-1">{show ? "Hide" : "Show"}</button>
      </div>
      {show && (
        <div className="space-y-2">
          <div className="flex flex-wrap gap-2">
            <button onClick={exportData} className="rounded-xl border px-3 py-1">Export → Textbox</button>
            <button onClick={importData} className="rounded-xl border px-3 py-1">Import ← Textbox</button>
            <button onClick={reset} className="rounded-xl border px-3 py-1 text-red-600">Reset</button>
          </div>
          <textarea className="h-52 w-full rounded-xl border p-2" value={txt} onChange={(e) => setTxt(e.target.value)} placeholder="Paste JSON here to import, or click Export first." />
        </div>
      )}
    </div>
  );
}

export default function App() {
  const [store, setStore] = useLocalState(STORAGE_KEY, { students: [] });
  const [activeWeek, setActiveWeek] = useState(1);
  const [activeStudentId, setActiveStudentId] = useState(null);

  const students = store.students || [];
  const setStudents = (fnOrArr) => {
    setStore((s) => ({ ...s, students: typeof fnOrArr === "function" ? fnOrArr(s.students || []) : fnOrArr }));
  };
  const activeStudent = students.find((s) => s.id === activeStudentId) || students[0];

  useEffect(() => {
    if (students.length && !activeStudentId) setActiveStudentId(students[0].id);
  }, [students.length]);

  return (
    <div className="mx-auto max-w-6xl space-y-4 p-4">
      <Header activeWeek={activeWeek} setActiveWeek={setActiveWeek} totalWeeks={36} />

      <StudentManager students={students} setStudents={setStudents} setActiveStudentId={setActiveStudentId} />

      {activeStudent ? (
        <StudentPanel student={activeStudent} setStudents={setStudents} week={activeWeek} />
      ) : (
        <div className="rounded-2xl border p-10 text-center text-gray-500">Add a student to get started.</div>
      )}

      <DataMenu data={store} setData={setStore} />

      <footer className="pb-10 pt-2 text-center text-xs text-gray-400">DJ Journey Tracker v8 • Local only • Tip: Export before clearing browser storage.</footer>
    </div>
  );
}
